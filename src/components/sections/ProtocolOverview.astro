---
// ProtocolOverview.astro
// Seven-step AgentVault protocol flow — scannable spec summary
---

<section class="section reveal" id="protocol">
  <div class="container">
    <h2>Protocol</h2>
    <p class="intro text-secondary">
      Seven steps from discovery to receipt. Each cryptographically bound to the
      terms established at the start. Contracts are pre-existing documents
      referenced by hash — never renegotiated mid-session.
    </p>

    <ol class="steps">
      <li class="step">
        <span class="step__number">1</span>
        <div class="step__body">
          <h3 class="step__title">Discovery</h3>
          <p>
            Agents publish <strong>signed descriptors</strong> — identity keys, declared capabilities, model profiles.
          </p>
        </div>
      </li>

      <li class="step">
        <span class="step__number">2</span>
        <div class="step__body">
          <h3 class="step__title">Invite</h3>
          <p>
            The initiator references a <strong>content-addressed contract</strong> by hash —
            purpose, output schema, model profile.
          </p>
        </div>
      </li>

      <li class="step">
        <span class="step__number">3</span>
        <div class="step__body">
          <h3 class="step__title">Accept / Decline</h3>
          <p>
            The responder verifies the contract hash and admits or denies. Decline is constant-shape —
            no reason field — preventing leakage through the denial itself.
          </p>
        </div>
      </li>

      <li class="step">
        <span class="step__number">4</span>
        <div class="step__body">
          <h3 class="step__title">Commitment</h3>
          <p>
            Encrypted inputs are submitted and bound to the contract hash via authenticated data.
          </p>
        </div>
      </li>

      <li class="step">
        <span class="step__number">5</span>
        <div class="step__body">
          <h3 class="step__title">Relay Execution</h3>
          <p>
            Model profile verified. Output validated against <strong>JSON Schema</strong>.
            Invalid output rejected and not returned.
          </p>
        </div>
      </li>

      <li class="step">
        <span class="step__number">6</span>
        <div class="step__body">
          <h3 class="step__title">Receipt</h3>
          <p>
            An <strong>Ed25519-signed receipt</strong> binds contract hash, guardian policy,
            prompt template, model identity, relay build, and output signal. Tamper-evident and independently verifiable.
          </p>
        </div>
      </li>

      <li class="step">
        <span class="step__number">7</span>
        <div class="step__body">
          <h3 class="step__title">Retrieval</h3>
          <p>
            Both agents retrieve the bounded signal and receipt.
          </p>
        </div>
      </li>
    </ol>

    <p class="protocol-coda text-secondary">
      Every artefact — contracts, schemas, prompt templates, guardian policies, model profiles —
      is content-addressed (SHA-256 over canonical JSON) and versioned. The receipt proves
      exactly which rules governed the session.
    </p>
    <p class="protocol-coda text-secondary">
      The vault emits compressed informational signals. It does not make decisions.
    </p>
  </div>
</section>

<style>
  h2 {
    max-width: var(--content-max);
    margin: 0 auto var(--space-md);
  }

  .intro {
    max-width: var(--content-max);
    margin: 0 auto var(--space-2xl);
  }

  .steps {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
    max-width: var(--content-max);
    margin: 0 auto;
  }

  .step {
    display: grid;
    grid-template-columns: 2.5rem 1fr;
    gap: var(--space-md);
    align-items: start;
    position: relative;
  }

  .step + .step::before {
    content: '';
    position: absolute;
    left: calc(1rem - 0.5px);
    top: calc(-1 * var(--space-lg));
    height: var(--space-lg);
    width: 1px;
    background: var(--color-vault-border);
  }

  .step__number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border: 1px solid var(--color-vault-border);
    border-radius: 50%;
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    color: var(--color-accent);
    background: var(--color-vault-bg);
    flex-shrink: 0;
    margin-top: -0.1rem;
  }

  .step__title {
    font-size: var(--text-base);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-xs);
  }

  .step__body p {
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
    line-height: var(--leading-relaxed);
    max-width: none;
  }

  .step__guarantee {
    font-size: var(--text-xs);
    color: var(--color-accent-dim);
    letter-spacing: 0.02em;
    margin-top: var(--space-xs);
  }

  .protocol-coda {
    max-width: var(--content-max);
    margin: var(--space-2xl) auto 0;
    font-size: var(--text-sm);
    line-height: var(--leading-relaxed);
  }
</style>
