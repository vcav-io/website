---
// ProtocolOverview.astro
// Seven-step AgentVault protocol flow — scannable spec summary
---

<section class="section reveal" id="protocol">
  <div class="container">
    <h2>Protocol</h2>
    <p class="intro text-secondary">
      Seven steps from discovery to receipt. Each cryptographically bound to the
      previous. Contracts are pre-existing documents referenced by hash — not
      negotiated in-protocol.
    </p>

    <ol class="steps">
      <li class="step">
        <span class="step__number">1</span>
        <div class="step__body">
          <h3 class="step__title">Discovery</h3>
          <p>
            Agents publish <strong>signed descriptors</strong> — Ed25519 keys, capabilities, model profiles. Signatures use domain separation (<code>VCAV-DESCRIPTOR-V1:</code>).
          </p>
          <p class="step__guarantee font-mono">Domain-separated signatures prevent cross-context descriptor reuse</p>
        </div>
      </li>

      <li class="step">
        <span class="step__number">2</span>
        <div class="step__body">
          <h3 class="step__title">Proposal</h3>
          <p>
            Initiator sends <code>PROPOSE</code> referencing a <strong>content-addressed contract</strong> by SHA-256 hash — purpose code, output schema, model profile, and execution lane.
          </p>
          <p class="step__guarantee font-mono">Content-addressed contract — immutable reference, not in-protocol negotiation</p>
        </div>
      </li>

      <li class="step">
        <span class="step__number">3</span>
        <div class="step__body">
          <h3 class="step__title">Admission</h3>
          <p>
            Responder issues <code>ADMIT</code> with a <strong>one-time admit token</strong>, confirming the same contract hash — or <code>DENY</code> with no reason field.
          </p>
          <p class="step__guarantee font-mono">Designed so that denial is constant-shape — no reason field, no information leakage</p>
        </div>
      </li>

      <li class="step">
        <span class="step__number">4</span>
        <div class="step__body">
          <h3 class="step__title">Commitment</h3>
          <p>
            Encrypted inputs submitted via admit token. <strong><code>XChaCha20-Poly1305</code></strong> with AAD binding ciphertext to the contract hash.
          </p>
          <p class="step__guarantee font-mono">Encryption with AAD binding — ciphertext is tied to the contract hash</p>
        </div>
      </li>

      <li class="step">
        <span class="step__number">5</span>
        <div class="step__body">
          <h3 class="step__title">Relay Execution</h3>
          <p>
            The relay <strong>enforces</strong>: verifies model profile hash, assembles prompt from content-addressed <code>PromptProgram</code>, calls LLM, validates output against <strong>JSON Schema</strong>. <code>GATE</code> rules reject; <code>ADVISORY</code> rules log.
          </p>
          <p class="step__guarantee font-mono">Schema violation aborts execution — only structured signals pass</p>
        </div>
      </li>

      <li class="step">
        <span class="step__number">6</span>
        <div class="step__body">
          <h3 class="step__title">Receipt</h3>
          <p>
            <strong>Ed25519 signed receipt</strong> binding contract hash, guardian policy, prompt template, model identity, model profile, relay build SHA, participants, and output signal.
          </p>
          <p class="step__guarantee font-mono">Any change to any bound input invalidates the receipt</p>
        </div>
      </li>

      <li class="step">
        <span class="step__number">7</span>
        <div class="step__body">
          <h3 class="step__title">Output Retrieval</h3>
          <p>
            Both agents retrieve the <strong>bounded output signal</strong> and receipt. The signal is structured data — each agent interprets it for its principal outside the vault.
          </p>
          <p class="step__guarantee font-mono">Structured signal, not natural language — agents interpret for their principal</p>
        </div>
      </li>
    </ol>
  </div>
</section>

<style>
  h2 {
    max-width: var(--content-max);
    margin: 0 auto var(--space-md);
  }

  .intro {
    max-width: var(--content-max);
    margin: 0 auto var(--space-2xl);
  }

  .steps {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
    max-width: var(--content-max);
    margin: 0 auto;
  }

  .step {
    display: grid;
    grid-template-columns: 2.5rem 1fr;
    gap: var(--space-md);
    align-items: start;
    position: relative;
  }

  .step + .step::before {
    content: '';
    position: absolute;
    left: calc(1rem - 0.5px);
    top: calc(-1 * var(--space-lg));
    height: var(--space-lg);
    width: 1px;
    background: var(--color-vault-border);
  }

  .step__number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border: 1px solid var(--color-vault-border);
    border-radius: 50%;
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    color: var(--color-accent);
    background: var(--color-vault-bg);
    flex-shrink: 0;
    margin-top: 0.1rem;
  }

  .step__title {
    font-size: var(--text-base);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-xs);
  }

  .step__body p {
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
    line-height: var(--leading-relaxed);
    max-width: none;
  }

  .step__guarantee {
    font-size: var(--text-xs);
    color: var(--color-accent-dim);
    letter-spacing: 0.02em;
    margin-top: var(--space-xs);
  }
</style>
